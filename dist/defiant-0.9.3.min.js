/* 
 * Defiant.js v0.9.3 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
if(module===void 0)var module={exports:void 0};if(module.exports=Defiant=function(){"use strict";function t(t){this._methods=[],this._owner=t,this._paused=!1}var e={env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,is_safari:"undefined"!=typeof navigator?null!==navigator.userAgent.match(/safari/i):!1,render:function(t,e){var n,r,i=new XSLTProcessor,a=document.createElement("span"),o={match:"/"};switch(typeof t){case"object":this.extend(o,t),o.data||(o.data=e);break;case"string":o.template=t,o.data=e;break;default:throw"error"}if(o.data=JSON.toXML(o.data),this.xsl_template||this.gather_templates(),r=this.node.selectSingleNode(this.xsl_template,'//xsl:template[@name="'+o.template+'"]'),r.setAttribute("match",o.match),i.importStylesheet(this.xsl_template),a.appendChild(i.transformToFragment(o.data,document)),r.removeAttribute("match"),this.is_safari){n=a.getElementsByTagName("script");for(var s=0,u=n.length;u>s;s++)n[s].defer=!0}return a.innerHTML},gather_templates:function(){for(var t=document.getElementsByTagName("script"),e="",n=0,r=t.length;r>n;n++)"defiant/xsl-template"===t[n].type&&(e+=t[n].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+e.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(t){var e,n=new DOMParser;return t=t.replace(/>\s{1,}</g,"><"),null===t.trim().match(/<\?xml/)&&(t=this.xml_decl+t),e=n.parseFromString(t,"text/xml")},extend:function(t,e){for(var n in e)t[n]&&"object"==typeof e[n]?this.extend(t[n],e[n]):t[n]=e[n];return t},result:function(){var t=function(e){for(var n in t.prototype)t.prototype.hasOwnProperty(n)&&(e[n]=t.prototype[n]);return e};return t.prototype={sum:function(t){for(var e=0,n=this.length,r=0;n>e;e++)r+=+this[e][t];return r},avg:function(t){return this.sum(t)/this.length},sortAsc:function(t){return this.sort(function(e,n){return e[t]-n[t]})},sortDesc:function(t){return this.sort(function(e,n){return n[t]-e[t]})},min:function(t,e){for(var n=0,r=this.length,i=[];r>n;n++)i.push(this[n][t]);return Math[e||"min"].apply(null,i)},max:function(t){return this.min(t,"max")},add:function(t,e,n){for(var r=0,i=this.length,a="string"==typeof e;i>r;r++)switch(n){case"divide":this[r][t]/=a?this[r][e]:+e;break;case"multiply":this[r][t]*=a?this[r][e]:+e;break;case"subtract":this[r][t]-=a?this[r][e]:+e;break;default:this[r][t]+=a?this[r][e]:+e}return this},subtract:function(t,e){return this.add(t,e,"subtract")},divide:function(t,e){return this.add(t,e,"divide")},multiply:function(t,e){return this.add(t,e,"multiply")},each:function(t){for(var e=0,n=this.length;n>e;e++)t(this[e]);return this}},new t(arguments[0])},ajax:function(r,i){var a=e.ajax;for(var o in n.prototype)n.prototype.hasOwnProperty(o)&&(a[o]=n.prototype[o]);return a.queue=new t(a),a.load(r,i)},node:{}},n=function(){};return n.prototype={callback:function(t){return this.data=t,this.queue._paused=!1,this.queue.flush(),this},load:function(t,e){var n=function(){var e=document.getElementsByTagName("head").item(0),n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("charset","utf-8"),n.setAttribute("src",t+"&callback=Defiant.ajax.callback"),e.appendChild(n)},r=function(){e(this.data)};return n._paused=!0,this.queue.add(n),e&&this.queue.add(r),this},each:function(t){var e=this;return this.queue.add(function(){for(var n=0,r=e.res.length;r>n;n++)t.call(e,e.res[n])}),this},search:function(t){var e=this,n=function(){e.res=JSON.search(this.data,t)};return this.queue.add(n),this}},t.prototype={add:function(t){this._methods.push(t),this._paused||this.flush()},flush:function(){if(!this._paused)for(;this._methods[0];){var t=this._methods.shift();if(t.call(this._owner),t._paused){this._paused=!0;break}}}},e}(this),void 0!==window.ActiveXObject){if(DOMParser===void 0){var DOMParser=function(){};DOMParser.prototype.parseFromString=function(t,e){var n;return"undefined"!=typeof ActiveXObject?(n=new ActiveXObject("MSXML.DomDocument"),n.async=!1,n.loadXML(t),n):"undefined"!=typeof XMLHttpRequest?(n=new XMLHttpRequest,e||(e="application/xml"),n.open("GET","data:"+e+";charset=utf-8,"+encodeURIComponent(t),!1),n.overrideMimeType&&n.overrideMimeType(e),n.send(null),n.responseXML):void 0}}if(XMLSerializer===void 0){var XMLSerializer=function(){};XMLSerializer.prototype={serializeToString:function(t){return t.xml}}}if(XSLTProcessor===void 0){var XSLTProcessor=function(){};XSLTProcessor.prototype={importStylesheet:function(t){this.xsldoc=t},transformToFragment:function(t){var e=t.transformNode(this.xsldoc),n=document.createElement("span");return n.innerHTML=e,n}}}Object.prototype.getName=function(){var t=/function (.{1,})\(/,e=t.exec(""+this);return e&&e.length>1?e[1]:""}}String.prototype.fill||(String.prototype.fill=function(t,e){var n=this;for(e=e||" ";t>n.length;n+=e);return n}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.count_nl||(String.prototype.count_nl=function(){var t=this.match(/\n/g);return t?t.length:0}),String.prototype.notabs||(String.prototype.notabs=function(){return this.replace(/\t/g,"")}),"undefined"==typeof JSON&&(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(t){if(t instanceof Object){var e="";if(t.constructor===Array){for(var n=0;t.length>n;e+=this.stringify(t[n])+",",n++);return"["+e.substr(0,e.length-1)+"]"}if(t.toString!==Object.prototype.toString)return'"'+(""+t).replace(/"/g,"\\$&")+'"';for(var r in t)e+='"'+r.replace(/"/g,"\\$&")+'":'+this.stringify(t[r])+",";return"{"+e.substr(0,e.length-1)+"}"}return"string"==typeof t?'"'+t.replace(/"/g,"\\$&")+'"':t+""}}),JSON.toXML||(JSON.toXML=function(t){"use strict";var e={replace:function(t){for(var e in this)delete this[e];Defiant.extend(this,t)},to_xml:function(t){var e=this.hash_to_xml(null,t);return Defiant.xmlFromString(e)},hash_to_xml:function(t,e,n){var r,i,a,o,s,u,l,c=e.constructor===Array,h=[],d=[];for(r in e)if(i=e[r],(null===i||void 0===i||"NaN"==""+i)&&(i=null),o="@"===r.slice(0,1),s=n?t:r,s==+s&&e.constructor!==Object&&(s="d:item"),null===i?(u=null,l=!1):(u=i.constructor,l=void 0!==u.name?u.name:u.getName()),o)d.push(s.slice(1)+'="'+this.escape_xml(i)+'"'),"String"!==l&&d.push("d:"+s.slice(1)+'="'+l+'"');else if(null===i)h.push(this.scalar_to_xml(s,i));else switch(u){case Object:h.push(this.hash_to_xml(s,i));break;case Array:if(r===s){if(a=i.constructor===Array)for(var f=0,p=i.length;p>f;f++)i[f].constructor===Array&&(a=!0),a||i[f].constructor!==Object||(a=!0);h.push(this.scalar_to_xml(s,i,a));break}case String:"string"==typeof i&&(i=(""+i).replace(/\&/g,"&amp;"));case Number:case Boolean:"#text"===s&&"String"!==l&&d.push('d:constr="'+l+'"'),h.push(this.scalar_to_xml(s,i));break;case Function:break;default:}return t||(t="d:data",d.push(Defiant.namespace),c&&d.push('d:constr="Array"')),null===t.match(/^(?!xml)[a-z_][\w\d.:]*$/i)&&(d.push('d:name="'+t+'"'),t="d:name"),n?h.join(""):"<"+t+(d.length?" "+d.join(" "):"")+(h.length?">"+h.join("")+"</"+t+">":"/>")},scalar_to_xml:function(t,e,n){var r,i,a,o="";return null===t.match(/^(?!xml)[a-z_][\w\d.:]*$/i)&&(o+=' d:name="'+t+'"',t="d:name",n=!1),(null===e||"NaN"==""+e)&&(e=null),null===e?"<"+t+' d:constr="null"/>':n?this.hash_to_xml(t,e,!0):(i=e.constructor,a=i.name||i.getName(),r=i===Array?this.hash_to_xml("d:item",e,!0):this.escape_xml(e),"String"!==a&&(o+=' d:constr="'+a+'"'),"#text"===t?this.escape_xml(e):"<"+t+o+">"+r+"</"+t+">")},escape_xml:function(t){return(t+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},n=e.to_xml.call(e,t);return e.replace.call(t,Defiant.node.toJSON(n.documentElement)),n}),JSON.search||(JSON.search=function(t,e,n){"use strict";var r,i,a,o,s,u,l=JSON.toXML(t),c=l.documentElement,h=Defiant.node[n?"selectSingleNode":"selectNodes"](l,e),d=[],f=[],p=function(t){if(a===d[m].length)return t;switch(t.constructor){case Array:for(var e,n=0,r=t.length;r>n;n++)if(o.val===JSON.stringify(t[n],null,"	")&&d[m].length>a)return a++,o=d[m][a],p(t[n]);if(n===r){if(o.val===JSON.stringify(t,null,"	"))for(a++,o=d[m][a],n=0;r>n;n++)if(e=p(t[n]))return e;return t}break;default:if(s=d[m][a].node.nodeType,u=1===s?d[m][a].node.getAttribute("d:name"):!1,u=u||o.key,t=t[u],"object"!=typeof t)return a++,o=d[m][a],t;t.constructor===Object&&(a++,o=d[m][a])}return p(t)};for(n&&(h=[h]),m=0,g=h.length;g>m;m++)if(r=[],i=h[m],i!==c){for(;i!==c;)s=2===i.nodeType,r.push({node:i,key:(s?"@":"")+i.nodeName,val:s?i.value:Defiant.node.toJSON(i,"	")}),i=s?i.ownerElement:i.parentNode;d.push(r.reverse())}for(var m=0,g=d.length;g>m;m++)a=0,o=d[m][a],f.push(p(t));return this.trace=JSON.search.trace?JSON.mtrace(t,d):!1,Defiant.result(f)}),JSON.mtrace||(JSON.mtrace=function(t,e){"use strict";for(var n,r,i,a,o,s,u,l=[],c=JSON.stringify(t,null,"	").notabs(),h=0,d=e.length;d>h;h++){r=e[h],o=0,n=c,i=r.length,a=null===r[i-1].val.match(/[\{\}:\[\]]/g),a&&i--,r[0].val.notabs()!==c&&i>0&&(n=r[0].val.notabs(),o+=c.indexOf(n));for(var f=0,p=i;p>f;f++)o+=n.indexOf(r[f].val.notabs()),n=r[f].val.notabs();a&&(o+=n.indexOf('"'+r[f].key+'": ')),s=c.slice(0,o).count_nl()+1,u=r[a?i:i-1].val.count_nl(),l.push([s,u])}return l}),Defiant.node.selectNodes=function(t,e){if(t.evaluate){for(var n=t.createNSResolver(t.documentElement),r=t.evaluate(e,t,n,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),i=[],a=0,o=r.snapshotLength;o>a;a++)i.push(r.snapshotItem(a));return i}return t.selectNodes(e)},Defiant.node.selectSingleNode=function(t,e){if(t.evaluate){var n=this.selectNodes(t,e);return n.length>0?n[0]:null}return t.selectSingleNode(e)},Defiant.node.prettyPrint=function(t){var e=Defiant.tabsize,n=Defiant.xml_decl.toLowerCase(),r=new XMLSerializer,i=r.serializeToString(t);"development"!==Defiant.env&&(i=i.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var a,o,s=i.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),u=s.split("\n"),l=-1,c=0,h=u.length;h>c;c++)(0!==c||u[c].toLowerCase()!==n)&&(a=null!==u[c].match(/<[A-Za-z_\:]+.*?>/g),o=null!==u[c].match(/<\/[\w\:]+>/g),null!==u[c].match(/<.*?\/>/g)&&(a=o=!0),a&&l++,u[c]="".fill(l,"	")+u[c],a&&o&&l--,!a&&o&&l--);return u.join("\n").replace(/\t/g,"".fill(e," "))},Defiant.node.toJSON=function(t,e){"use strict";var n=function(t){var e,r,i,a,o,s,u,l={};switch(t.nodeType){case 1:r=t.getAttribute("d:constr"),"Array"===r&&(l=[]),e=t.attributes;for(var c,h=0,d=e.length;d>h;h++)c=e.item(h),null===c.nodeName.match(/\:d|d\:/g)&&(r=t.getAttribute("d:"+c.nodeName),s=r&&"undefined"!==r?window[r]("false"===c.nodeValue?"":c.nodeValue):c.nodeValue,l["@"+c.nodeName]=s);break;case 3:r=t.parentNode.getAttribute("d:type"),s=r?window[r]("false"===t.nodeValue?"":t.nodeValue):t.nodeValue,l=s}if(t.hasChildNodes())for(var f=0,p=t.childNodes.length;p>f;f++)if(i=t.childNodes.item(f),a=i.nodeName,e=t.attributes,"d:name"===a&&(a=i.getAttribute("d:name")),"#text"===a)o=t.getAttribute("d:constr"),"undefined"===o&&(o=void 0),u=i.textContent||i.text,s="Boolean"===o&&"false"===u?"":u,o||e.length?o&&1===e.length?l=window[o](s):t.hasChildNodes()?3>e.length?l=o?window[o](s):s:l[a]=o?window[o](s):s:l[a]=o?window[o](s):s:l=s;else{if(l[a]){l[a].push?l[a].push(n(i)):l[a]=[l[a],n(i)];continue}switch(o=i.getAttribute("d:constr")){case"null":l.push?l.push(null):l[a]=null;break;case"Array":i.parentNode.firstChild===i&&"Array"===o&&"d:item"!==a?l[a]="d:item"===a||"Array"===o?[n(i)]:n(i):l.push?l.push(n(i)):l[a]=n(i);break;case"String":case"Number":case"Boolean":u=i.textContent||i.text,s="Boolean"===o&&"false"===u?"":u,l.push?l.push(window[o](s)):l[a]=n(i);break;default:l.push?l.push(n(i)):l[a]=n(i)}}return l},r=9===t.nodeType?t.documentElement:t,i=n(r),a=i[r.nodeName];return r===r.ownerDocument.documentElement&&a&&a.constructor===Array&&(i=a),e&&"true"==""+e&&(e="	"),e?JSON.stringify(i,null,e):i},"undefined"!=typeof jQuery&&function(t){"use strict";t.fn.defiant=function(t,e){return this.html(Defiant.render(t,e)),this}}(jQuery);