/* 
 * Defiant.js v0.8.8 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
if("undefined"==typeof module)module={exports:void 0};else{var dom=require("xmldom");this.Document=Document=dom.DOMImplementation,this.DOMParser=DOMParser=dom.DOMParser,this.XMLSerializer=XMLSerializer=dom.XMLSerializer,document=(new Document).createDocument(null,null,null)}module.exports=Defiant=function(t){"use strict";var e={env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,is_safari:"undefined"!=typeof navigator?null!==navigator.userAgent.match(/safari/i):!1,render:function(t,e){var r,n,s=new XSLTProcessor,a=document.createElement("span"),i={match:"/"};switch(typeof t){case"object":this.extend(i,t),i.data||(i.data=e);break;case"string":i.template=t,i.data=e;break;default:throw"error"}if(i.data=JSON.toXML(i.data),this.xsl_template||this.gather_templates(),n=this.xsl_template.selectSingleNode('//xsl:template[@name="'+i.template+'"]'),n.setAttribute("match",i.match),s.importStylesheet(this.xsl_template),a.appendChild(s.transformToFragment(i.data,document)),n.removeAttribute("match"),this.is_safari){r=a.getElementsByTagName("script");for(var o=0,l=r.length;l>o;o++)r[o].defer=!0}return a.innerHTML},gather_templates:function(){for(var t=document.getElementsByTagName("script"),e="",r=0,n=t.length;n>r;r++)"defiant/xsl-template"===t[r].type&&(e+=t[r].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+e.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(e){var r,n;return e=e.replace(/>\s{1,}</g,"><"),null===e.match(/<\?xml/)&&(e=this.xml_decl+e),t.DOMParser?(r=new DOMParser,n=r.parseFromString(e,"text/xml")):(n=new ActiveXObject("Microsoft.XMLDOM"),n.async="false",n.loadXML(e)),n},extend:function(t,e){for(var r in e)t[r]&&"object"==typeof e[r]?this.extend(t[r],e[r]):t[r]=e[r];return t},prettyPrint:function(t){var e=this.tabsize,r=this.xml_decl.toLowerCase(),n=new XMLSerializer,s=n.serializeToString(t);"development"!==this.env&&(s=s.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var a,i,o=s.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),l=o.split("\n"),u=-1,c=0,h=l.length;h>c;c++)(0!==c||l[c].toLowerCase()!==r)&&(a=null!==l[c].match(/<[^\/]+>/g),i=null!==l[c].match(/<\/[\w\:]+>/g),null!==l[c].match(/<.*?\/>/g)&&(a=i=!0),a&&u++,l[c]="".fill(u,"	")+l[c],a&&i&&u--,!a&&i&&u--);return l.join("\n").replace(/\t/g,"".fill(e," "))},nodeToJSON:function(e,r){var n=function(e){var r,s,a,i,o,l,u={};switch(e.nodeType){case 1:s=e.getAttribute("d:constr"),"Array"===s&&(u=[]),r=e.attributes;for(var c,h=0,f=r.length;f>h;h++)c=r.item(h),null===c.nodeName.match(/\:d|d\:/g)&&(s=e.getAttribute("d:"+c.nodeName),l=s?t[s]("false"===c.nodeValue?"":c.nodeValue):c.nodeValue,u["@"+c.nodeName]=l);break;case 3:s=e.parentNode.getAttribute("d:type"),l=s?t[s]("false"===e.nodeValue?"":e.nodeValue):e.nodeValue,u=l}if(e.hasChildNodes())for(var m=0,p=e.childNodes.length;p>m;m++)if(a=e.childNodes.item(m),i=a.nodeName,r=e.attributes,"#text"===i)o=e.getAttribute("d:constr"),l="Boolean"===o&&"false"===a.textContent?"":a.textContent,o||r.length?o&&1===r.length?u=t[o](l):u[i]=o?t[o](l):l:u=l;else{if(u[i]){u[i].push?u[i].push(n(a)):u[i]=[u[i],n(a)];continue}switch(o=a.getAttribute("d:constr")){case"null":u.push?u.push(null):u[i]=null;break;case"Array":a.parentNode.firstChild===a&&"Array"===a.getAttribute("d:constr")&&"item"!==i?u[i]=[n(a)]:u.push?u.push(n(a)):u[i]=n(a);break;case"String":case"Number":case"Boolean":l="Boolean"===o&&"false"===a.textContent?"":a.textContent,u.push?u.push(t[o](l)):u[i]=n(a);break;default:u.push?u.push(n(a)):u[i]=n(a)}}return u},e=9===e.nodeType?e.documentElement:e,s=n(e),a=s[e.nodeName];return e===e.ownerDocument.documentElement&&a&&a.constructor===Array&&(s=a),r&&"true"==""+r&&(r="	"),r?JSON.stringify(s,null,r):s},result:function(){var t=function(e){var r=Object.create(Array.prototype);for(var n in t.prototype)t.prototype.hasOwnProperty(n)&&(r[n]=t.prototype[n]);for(var s=0,a=e.length;a>s;s++)r.push(e[s]);return r};return t.prototype={toArray:function(){return Array.prototype.slice.call(this,0)},sum:function(t){for(var e=0,r=this.length,n=0;r>e;e++)n+=+this[e][t];return n},avg:function(t){return this.sum(t)/this.length},min:function(t,e){for(var r=0,n=this.length,s=[];n>r;r++)s.push(this[r][t]);return Math[e||"min"].apply(null,s)},max:function(t){return this.min(t,"max")},add:function(t,e,r){for(var n=0,s=this.length,a="string"==typeof e;s>n;n++)switch(r){case"divide":this[n][t]/=a?this[n][e]:+e;break;case"multiply":this[n][t]*=a?this[n][e]:+e;break;case"subtract":this[n][t]-=a?this[n][e]:+e;break;default:this[n][t]+=a?this[n][e]:+e}return this},subtract:function(t,e){return this.add(t,e,"subtract")},divide:function(t,e){return this.add(t,e,"divide")},multiply:function(t,e){return this.add(t,e,"multiply")},each:function(t){for(var e=0,r=this.length;r>e;e++)t(this[e]);return this}},new t(arguments[0])}};return e}(this),String.prototype.fill||(String.prototype.fill=function(t,e){var r=this;for(e=e||" ";t>r.length;r+=e);return r}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.count_nl||(String.prototype.count_nl=function(){var t=this.match(/\n/g);return t?t.length:0}),String.prototype.notabs||(String.prototype.notabs=function(){return this.replace(/\t/g,"")}),Document.selectNodes||(Document.prototype.selectNodes=function(t,e){e||(e=this),this.ns=this.createNSResolver(this.documentElement),this.qI=this.evaluate(t,e,this.ns,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var r=[],n=0,s=this.qI.snapshotLength;s>n;n++)r.push(this.qI.snapshotItem(n));return r}),Document.selectSingleNode||(Document.prototype.selectSingleNode=function(t,e){return e||(e=this),this.xI=this.selectNodes(t,e),this.xI.length>0?this.xI[0]:null}),"undefined"==typeof JSON&&(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(t){if(t instanceof Object){var e="";if(t.constructor===Array){for(var r=0;t.length>r;e+=this.stringify(t[r])+",",r++);return"["+e.substr(0,e.length-1)+"]"}if(t.toString!==Object.prototype.toString)return'"'+(""+t).replace(/"/g,"\\$&")+'"';for(var n in t)e+='"'+n.replace(/"/g,"\\$&")+'":'+this.stringify(t[n])+",";return"{"+e.substr(0,e.length-1)+"}"}return"string"==typeof t?'"'+t.replace(/"/g,"\\$&")+'"':t+""}}),JSON.toXML||(JSON.toXML=function(t){"use strict";var e={repl:function(t){for(var e in this)delete this[e];Defiant.extend(this,t)},to_xml:function(t){var e=this.hash_to_xml(null,t);return Defiant.xmlFromString(e)},hash_to_xml:function(t,e,r){var n,s,a,i,o,l,u=e.constructor===Array,c=[],h=[];for(n in e)if(s=e[n],(null===s||"NaN"==""+s)&&(s=null),i="@"===n.slice(0,1),o=r?t:n,o=o==+o?"item":o,l=null===s?null:s.constructor,i)h.push(o.slice(1)+'="'+this.escape_xml(s)+'"'),"String"!==l.name&&h.push("d:"+o.slice(1)+'="'+l.name+'"');else if(null===s)c.push(this.scalar_to_xml(o,s));else switch(l){case Object:c.push(this.hash_to_xml(o,s));break;case Array:if(n===o){if(a=s.constructor===Array)for(var f=0,m=s.length;m>f;f++)s[f].constructor===Array&&(a=!0),a||s[f].constructor!==Object||(a=!0);c.push(this.scalar_to_xml(o,s,a));break}case String:"string"==typeof s&&(s=(""+s).replace(/\&/g,"&amp;"));case Number:case Boolean:"#text"===o&&"String"!==l.name&&h.push('d:constr="'+l.name+'"'),c.push(this.scalar_to_xml(o,s));break;default:throw"ERROR! "+n}return t||(t="d:data",h.push(Defiant.namespace),u&&h.push('d:constr="Array"')),r?c.join(""):"<"+t+(h.length?" "+h.join(" "):"")+(c.length?">"+c.join("")+"</"+t+">":"/>")},scalar_to_xml:function(t,e,r){var n,s,a;return(null===e||"NaN"==""+e)&&(e=null),null===e?"<"+t+' d:constr="null"/>':r?this.hash_to_xml(t,e,!0):(a=e.constructor,n=a===Array?this.hash_to_xml("item",e,!0):this.escape_xml(e),s=' d:constr="'+a.name+'"',"String"===a.name&&(s=""),"#text"===t?this.escape_xml(e):"<"+t+s+">"+n+"</"+t+">")},escape_xml:function(t){return(t+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},r=e.to_xml.call(e,t);return e.repl.call(t,Defiant.nodeToJSON(r.documentElement)),r}),JSON.search||(JSON.search=function(t,e,r){"use strict";var n,s,a,i,o,l=JSON.toXML(t),u=l.documentElement,c=l[r?"selectSingleNode":"selectNodes"](e),h=[],f=[],m=function(t){if(a===h[p].length)return t;switch(t.constructor){case Array:for(var e,r=t.length,n=0;r>n;n++)if(i.val===JSON.stringify(t[n],null,"	")&&h[p].length>a)return a++,i=h[p][a],m(t[n]);if(n===r){if(i.val===JSON.stringify(t,null,"	"))for(a++,i=h[p][a],n=0;r>n;n++)if(e=m(t[n]))return e;return t}break;default:if(t=t[i.key],"object"!=typeof t)return a++,i=h[p][a],t;t.constructor===Object&&(a++,i=h[p][a])}return m(t)};for(r&&(c=[c]),p=0,d=c.length;d>p;p++)if(n=[],s=c[p],s!==u){for(;s!==u;)o=2===s.nodeType,n.push({node:s,key:(o?"@":"")+s.nodeName,val:o?s.value:Defiant.nodeToJSON(s,"	")}),s=o?s.ownerElement:s.parentNode;h.push(n.reverse())}for(var p=0,d=h.length;d>p;p++)a=0,i=h[p][a],f.push(m(t));return this.trace=JSON.search.trace?JSON.mtrace(t,h):!1,Defiant.result(f)}),JSON.mtrace||(JSON.mtrace=function(t,e){"use strict";for(var r,n,s,a,i,o,l,u=[],c=JSON.stringify(t,null,"	").notabs(),h=0,f=e.length;f>h;h++){n=e[h],i=0,r=c,s=n.length,a=null===n[s-1].val.match(/[\{\}:\[\]]/g),a&&s--,n[0].val.notabs()!==c&&s>0&&(r=n[0].val.notabs(),i+=c.indexOf(r));for(var m=0,p=s;p>m;m++)i+=r.indexOf(n[m].val.notabs()),r=n[m].val.notabs();a&&(i+=r.indexOf('"'+n[m].key+'": ')),o=c.slice(0,i).count_nl()+1,l=n[a?s:s-1].val.count_nl(),u.push([o,l])}return u}),"undefined"!=typeof jQuery&&function(t){"use strict";t.fn.defiant=function(t,e){return this.html(Defiant.render(t,e)),this}}(jQuery);