/* 
 * Defiant.js v0.8.3 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
(function(t,e){"use strict";var n={env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,is_safari:null!==navigator.userAgent.match(/safari/i),render:function(t,n){var r,s,o=new XSLTProcessor,i=e.createElement("span"),a={match:"/"};switch(typeof t){case"object":this.extend(a,t),a.data||(a.data=n);break;case"string":a.template=t,a.data=n;break;default:throw"error"}if(a.data=JSON.toXML(a.data),this.xsl_template||this.gather_templates(),s=this.xsl_template.selectSingleNode('//xsl:template[@name="'+a.template+'"]'),s.setAttribute("match",a.match),o.importStylesheet(this.xsl_template),i.appendChild(o.transformToFragment(a.data,e)),s.removeAttribute("match"),this.is_safari){r=i.getElementsByTagName("script");for(var l=0,c=r.length;c>l;l++)r[l].defer=!0}return i.innerHTML},gather_templates:function(){for(var t=e.getElementsByTagName("script"),n="defiant/xsl-template",r="",s=0,o=t.length;o>s;s++)t[s].type===n&&(r+=t[s].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+r.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(e){var n,r;return e=e.replace(/>\s{1,}</g,"><"),null===e.match(/<\?xml/)&&(e=this.xml_decl+e),t.DOMParser?(n=new DOMParser,r=n.parseFromString(e,"text/xml")):(r=new ActiveXObject("Microsoft.XMLDOM"),r.async="false",r.loadXML(e)),r},extend:function(t,e){for(var n in e)t[n]&&"object"==typeof e[n]?this.extend(t[n],e[n]):t[n]=e[n];return t}};t.Defiant=n})(window,document),String.prototype.fill||(String.prototype.fill=function(t,e){var n=this;for(e=e||" ";t>n.length;n+=e);return n}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),Document.selectNodes||(Document.prototype.selectNodes=function(t,e){e||(e=this),this.ns=this.createNSResolver(this.documentElement),this.qI=this.evaluate(t,e,this.ns,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var n=[],r=0,s=this.qI.snapshotLength;s>r;r++)n.push(this.qI.snapshotItem(r));return n}),Node.selectNodes||(Node.prototype.selectNodes=function(t){return this.ownerDocument.selectNodes(t,this)}),Document.selectSingleNode||(Document.prototype.selectSingleNode=function(t,e){return e||(e=this),this.xI=this.selectNodes(t,e),this.xI.length>0?this.xI[0]:null}),Node.selectSingleNode||(Node.prototype.selectSingleNode=function(t){return this.ownerDocument.selectSingleNode(t,this)}),Node.xml||Node.prototype.__defineGetter__("xml",function(){var t=Defiant.tabsize,e=Defiant.xml_decl.toLowerCase(),n=new XMLSerializer,r=n.serializeToString(this);"development"!==Defiant.env&&(r=r.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var s,o,i=r.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),a=i.split("\n"),l=-1,c=0,u=a.length;u>c;c++)(0!==c||a[c].toLowerCase()!==e)&&(s=null!==a[c].match(/<[^\/]+>/g),o=null!==a[c].match(/<\/[\w\:]+>/g),null!==a[c].match(/<.*?\/>/g)&&(s=o=!0),s&&l++,a[c]="".fill(l,"	")+a[c],s&&o&&l--,!s&&o&&l--);return a.join("\n").replace(/\t/g,"".fill(t," "))}),Node.text||(Node.prototype.__defineGetter__("text",function(){return this.textContent}),Node.prototype.__defineSetter__("text",function(t){this.textContent=t})),Node.toJSON||(Node.prototype.toJSON=function(t){"use strict";var e=function(t){var n,r,s,o,i,a,l={};switch(t.nodeType){case 1:r=t.getAttribute("d:constr"),"Array"===r&&(l=[]),n=t.attributes;for(var c,u=0,h=n.length;h>u;u++)c=n.item(u),null===c.nodeName.match(/\:d|d\:/g)&&(r=t.getAttribute("d:"+c.nodeName),a=r?window[r]("false"===c.nodeValue?"":c.nodeValue):c.nodeValue,l["@"+c.nodeName]=a);break;case 3:throw"ERROR! "+t.nodeName}if(t.hasChildNodes())for(var f=0,m=t.childNodes.length;m>f;f++)if(s=t.childNodes.item(f),o=s.nodeName,n=t.attributes,"#text"===o)i=t.getAttribute("d:constr"),a="Boolean"===i&&"false"===s.textContent?"":s.textContent,i||n.length?i&&1===n.length?l=window[i](a):l[o]=i?window[i](a):a:l=a;else{if(l[o]){l[o].push?l[o].push(e(s)):l[o]=[l[o],e(s)];continue}switch(i=s.getAttribute("d:constr")){case"null":l.push?l.push(null):l[o]=null;break;case"Array":s.parentNode.firstChild===s&&"Array"===s.getAttribute("d:constr")&&"item"!==o?l[o]=[e(s)]:l.push?l.push(e(s)):l[o]=e(s);break;case"String":case"Number":case"Boolean":a="Boolean"===i&&"false"===s.textContent?"":s.textContent,l.push?l.push(window[i](a)):l[o]=e(s);break;default:l.push?l.push(e(s)):l[o]=e(s)}}return l},n=9===this.nodeType?this.documentElement:this,r=e(n),s=r[n.nodeName];return n===n.ownerDocument.documentElement&&s&&s.constructor===Array&&(r=s),t?JSON.stringify(r,null,"	"):r}),window.JSON||(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(t){if(t instanceof Object){var e="";if(t.constructor===Array){for(var n=0;t.length>n;e+=this.stringify(t[n])+",",n++);return"["+e.substr(0,e.length-1)+"]"}if(t.toString!==Object.prototype.toString)return'"'+(""+t).replace(/"/g,"\\$&")+'"';for(var r in t)e+='"'+r.replace(/"/g,"\\$&")+'":'+this.stringify(t[r])+",";return"{"+e.substr(0,e.length-1)+"}"}return"string"==typeof t?'"'+t.replace(/"/g,"\\$&")+'"':t+""}}),JSON.toXML||(JSON.toXML=function(t){"use strict";var e={repl:function(t){for(var e in this)delete this[e];Defiant.extend(this,t)},to_xml:function(t){var e=this.hash_to_xml(null,t);return Defiant.xmlFromString(e)},hash_to_xml:function(t,e,n){var r,s,o,i,a,l,c=e.constructor===Array,u=[],h=[];for(r in e)if(s=e[r],(null===s||"NaN"==""+s)&&(s=null),i="@"===r.slice(0,1),a=n?t:r,a=a==+a?"item":a,l=null===s?null:s.constructor,i)h.push(a.slice(1)+'="'+this.escape_xml(s)+'"'),"String"!==l.name&&h.push("d:"+a.slice(1)+'="'+l.name+'"');else if(null===s)u.push(this.scalar_to_xml(a,s));else switch(l){case Object:u.push(this.hash_to_xml(a,s));break;case Array:if(r===a){if(o=s.constructor===Array)for(var f=0,m=s.length;m>f;f++)s[f].constructor===Array&&(o=!0),o||s[f].constructor!==Object||(o=!0);u.push(this.scalar_to_xml(a,s,o));break}case String:"string"==typeof s&&(s=(""+s).replace(/\&/g,"&amp;"));case Number:case Boolean:"#text"===a&&"String"!==l.name&&h.push('d:constr="'+l.name+'"'),u.push(this.scalar_to_xml(a,s));break;default:throw"ERROR! "+r}return t||(t="data",h.push(Defiant.namespace),c&&h.push('d:constr="Array"')),n?u.join(""):"<"+t+(h.length?" "+h.join(" "):"")+(u.length?">"+u.join("")+"</"+t+">":"/>")},scalar_to_xml:function(t,e,n){var r,s,o;return(null===e||"NaN"==""+e)&&(e=null),null===e?"<"+t+' d:constr="null"/>':n?this.hash_to_xml(t,e,!0):(o=e.constructor,r=o===Array?this.hash_to_xml("item",e,!0):this.escape_xml(e),s=' d:constr="'+o.name+'"',"String"===o.name&&(s=""),"#text"===t?this.escape_xml(e):"<"+t+s+">"+r+"</"+t+">")},escape_xml:function(t){return(t+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},n=e.to_xml.call(e,t);return e.repl.call(t,n.documentElement.toJSON()),n}),JSON.search||(JSON.search=function(t,e,n){"use strict";var r,s,o,i,a,l=JSON.toXML(t),c=l[n?"selectSingleNode":"selectNodes"](e),u=[],h=function(t){if(o===u[f].length)return t;switch(t.constructor){case Array:for(var e,n=t.length,r=0;n>r;r++)if(i.val===JSON.stringify(t[r],null,"	")&&u[f].length>o)return o++,i=u[f][o],h(t[r]);if(r===n){if(i.val===JSON.stringify(t,null,"	"))for(o++,i=u[f][o],r=0;n>r;r++)if(e=h(t[r]))return e;return t}break;default:if(t=t[i.key],"object"!=typeof t)return t;t.constructor===Object&&(o++,i=u[f][o])}return h(t)};for(n&&(c=[c]),f=0,m=u.length;m>f;f++){for(r=[],s=c[f];s!==l.documentElement;)a=2===s.nodeType,r.push({node:s,key:(a?"@":"")+s.nodeName,val:a?s.value:s.toJSON(!0)}),s=a?s.ownerElement:s.parentNode;u.push(r.reverse())}for(var f=0,m=u.length;m>f;f++)o=0,i=u[f][o],u[f]=h(t);return u}),"undefined"!=typeof jQuery&&function(t){"use strict";t.fn.defiant=function(t,e){return this.html(Defiant.render(t,e)),this}}(jQuery);