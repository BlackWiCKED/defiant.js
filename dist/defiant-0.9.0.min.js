/* 
 * Defiant.js v0.9.0 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
"undefined"==typeof module&&(module={exports:void 0}),module.exports=Defiant=function(t){"use strict";var e={env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,is_safari:"undefined"!=typeof navigator?null!==navigator.userAgent.match(/safari/i):!1,render:function(t,e){var r,n,a=new XSLTProcessor,i=document.createElement("span"),s={match:"/"};switch(typeof t){case"object":this.extend(s,t),s.data||(s.data=e);break;case"string":s.template=t,s.data=e;break;default:throw"error"}if(s.data=JSON.toXML(s.data),this.xsl_template||this.gather_templates(),n=this.xsl_template.selectSingleNode('//xsl:template[@name="'+s.template+'"]'),n.setAttribute("match",s.match),a.importStylesheet(this.xsl_template),i.appendChild(a.transformToFragment(s.data,document)),n.removeAttribute("match"),this.is_safari){r=i.getElementsByTagName("script");for(var o=0,l=r.length;l>o;o++)r[o].defer=!0}return i.innerHTML},gather_templates:function(){for(var t=document.getElementsByTagName("script"),e="",r=0,n=t.length;n>r;r++)"defiant/xsl-template"===t[r].type&&(e+=t[r].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+e.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(e){var r,n;return e=e.replace(/>\s{1,}</g,"><"),null===e.match(/<\?xml/)&&(e=this.xml_decl+e),t.DOMParser?(r=new DOMParser,n=r.parseFromString(e,"text/xml")):(n=new ActiveXObject("Microsoft.XMLDOM"),n.async="false",n.loadXML(e)),n},extend:function(t,e){for(var r in e)t[r]&&"object"==typeof e[r]?this.extend(t[r],e[r]):t[r]=e[r];return t},result:function(){var t=function(e){var r=Object.create(Array.prototype);for(var n in t.prototype)t.prototype.hasOwnProperty(n)&&(r[n]=t.prototype[n]);for(var a=0,i=e.length;i>a;a++)r.push(e[a]);return r};return t.prototype={toArray:function(){return Array.prototype.slice.call(this,0)},sum:function(t){for(var e=0,r=this.length,n=0;r>e;e++)n+=+this[e][t];return n},avg:function(t){return this.sum(t)/this.length},sortAsc:function(t){return this.sort(function(e,r){return e[t]-r[t]})},sortDesc:function(t){return this.sort(function(e,r){return r[t]-e[t]})},min:function(t,e){for(var r=0,n=this.length,a=[];n>r;r++)a.push(this[r][t]);return Math[e||"min"].apply(null,a)},max:function(t){return this.min(t,"max")},add:function(t,e,r){for(var n=0,a=this.length,i="string"==typeof e;a>n;n++)switch(r){case"divide":this[n][t]/=i?this[n][e]:+e;break;case"multiply":this[n][t]*=i?this[n][e]:+e;break;case"subtract":this[n][t]-=i?this[n][e]:+e;break;default:this[n][t]+=i?this[n][e]:+e}return this},subtract:function(t,e){return this.add(t,e,"subtract")},divide:function(t,e){return this.add(t,e,"divide")},multiply:function(t,e){return this.add(t,e,"multiply")},each:function(t){for(var e=0,r=this.length;r>e;e++)t(this[e]);return this}},new t(arguments[0])}};return e}(this),String.prototype.fill||(String.prototype.fill=function(t,e){var r=this;for(e=e||" ";t>r.length;r+=e);return r}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.count_nl||(String.prototype.count_nl=function(){var t=this.match(/\n/g);return t?t.length:0}),String.prototype.notabs||(String.prototype.notabs=function(){return this.replace(/\t/g,"")}),"undefined"==typeof JSON&&(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(t){if(t instanceof Object){var e="";if(t.constructor===Array){for(var r=0;t.length>r;e+=this.stringify(t[r])+",",r++);return"["+e.substr(0,e.length-1)+"]"}if(t.toString!==Object.prototype.toString)return'"'+(""+t).replace(/"/g,"\\$&")+'"';for(var n in t)e+='"'+n.replace(/"/g,"\\$&")+'":'+this.stringify(t[n])+",";return"{"+e.substr(0,e.length-1)+"}"}return"string"==typeof t?'"'+t.replace(/"/g,"\\$&")+'"':t+""}}),JSON.toXML||(JSON.toXML=function(t){"use strict";var e={replace:function(t){for(var e in this)delete this[e];Defiant.extend(this,t)},to_xml:function(t){var e=this.hash_to_xml(null,t);return Defiant.xmlFromString(e)},hash_to_xml:function(t,e,r){var n,a,i,s,o,l,u=e.constructor===Array,c=[],h=[];for(n in e)if(a=e[n],(null===a||"NaN"==""+a)&&(a=null),s="@"===n.slice(0,1),o=r?t:n,o=o==+o?"d:item":o,l=null===a?null:a.constructor,s)h.push(o.slice(1)+'="'+this.escape_xml(a)+'"'),"String"!==l.name&&h.push("d:"+o.slice(1)+'="'+l.name+'"');else if(null===a)c.push(this.scalar_to_xml(o,a));else switch(l){case Object:c.push(this.hash_to_xml(o,a));break;case Array:if(n===o){if(i=a.constructor===Array)for(var f=0,m=a.length;m>f;f++)a[f].constructor===Array&&(i=!0),i||a[f].constructor!==Object||(i=!0);c.push(this.scalar_to_xml(o,a,i));break}case String:"string"==typeof a&&(a=(""+a).replace(/\&/g,"&amp;"));case Number:case Boolean:"#text"===o&&"String"!==l.name&&h.push('d:constr="'+l.name+'"'),c.push(this.scalar_to_xml(o,a));break;default:throw"ERROR! "+n}return t||(t="d:data",h.push(Defiant.namespace),u&&h.push('d:constr="Array"')),null===t.match(/^(?!xml)[a-z_][\w\d.:]*$/i)&&(h.push('d:name="'+t+'"'),t="d:name"),r?c.join(""):"<"+t+(h.length?" "+h.join(" "):"")+(c.length?">"+c.join("")+"</"+t+">":"/>")},scalar_to_xml:function(t,e,r){var n,a,i="";return null===t.match(/^(?!xml)[a-z_][\w\d.:]*$/i)&&(i+=' d:name="'+t+'"',t="d:name",r=!1),(null===e||"NaN"==""+e)&&(e=null),null===e?"<"+t+' d:constr="null"/>':r?this.hash_to_xml(t,e,!0):(a=e.constructor,n=a===Array?this.hash_to_xml("d:item",e,!0):this.escape_xml(e),"String"!==a.name&&(i+=' d:constr="'+a.name+'"'),"#text"===t?this.escape_xml(e):"<"+t+i+">"+n+"</"+t+">")},escape_xml:function(t){return(t+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},r=e.to_xml.call(e,t);return e.replace.call(t,r.documentElement.toJSON()),r}),JSON.search||(JSON.search=function(t,e,r){"use strict";var n,a,i,s,o,l=JSON.toXML(t),u=l.documentElement,c=l[r?"selectSingleNode":"selectNodes"](e),h=[],f=[],m=function(t){if(i===h[p].length)return t;switch(t.constructor){case Array:for(var e,r=t.length,n=0;r>n;n++)if(s.val===JSON.stringify(t[n],null,"	")&&h[p].length>i)return i++,s=h[p][i],m(t[n]);if(n===r){if(s.val===JSON.stringify(t,null,"	"))for(i++,s=h[p][i],n=0;r>n;n++)if(e=m(t[n]))return e;return t}break;default:if(t=t[s.key],"object"!=typeof t)return i++,s=h[p][i],t;t.constructor===Object&&(i++,s=h[p][i])}return m(t)};for(r&&(c=[c]),p=0,d=c.length;d>p;p++)if(n=[],a=c[p],a!==u){for(;a!==u;)o=2===a.nodeType,n.push({node:a,key:(o?"@":"")+a.nodeName,val:o?a.value:a.toJSON("	")}),a=o?a.ownerElement:a.parentNode;h.push(n.reverse())}for(var p=0,d=h.length;d>p;p++)i=0,s=h[p][i],f.push(m(t));return this.trace=JSON.search.trace?JSON.mtrace(t,h):!1,Defiant.result(f)}),JSON.mtrace||(JSON.mtrace=function(t,e){"use strict";for(var r,n,a,i,s,o,l,u=[],c=JSON.stringify(t,null,"	").notabs(),h=0,f=e.length;f>h;h++){n=e[h],s=0,r=c,a=n.length,i=null===n[a-1].val.match(/[\{\}:\[\]]/g),i&&a--,n[0].val.notabs()!==c&&a>0&&(r=n[0].val.notabs(),s+=c.indexOf(r));for(var m=0,p=a;p>m;m++)s+=r.indexOf(n[m].val.notabs()),r=n[m].val.notabs();i&&(s+=r.indexOf('"'+n[m].key+'": ')),o=c.slice(0,s).count_nl()+1,l=n[i?a:a-1].val.count_nl(),u.push([o,l])}return u}),"undefined"!=typeof jQuery&&function(t){"use strict";t.fn.defiant=function(t,e){return this.html(Defiant.render(t,e)),this}}(jQuery);