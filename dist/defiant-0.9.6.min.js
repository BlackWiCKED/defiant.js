/* 
 * Defiant.js v0.9.6 
 * Smart templating with XSLT and XPath. 
 * http://defiantjs.com 
 * 
 * Copyright (c) 2013-2014, Hakan Bilgin <hbi@longscript.com> 
 * Licensed under the MIT License 
 */ 
if(module===void 0)var module={exports:void 0};if(module.exports=Defiant=function(){"use strict";function t(t){this._methods=[],this._owner=t,this._paused=!1}var e={env:"production",xml_decl:'<?xml version="1.0" encoding="utf-8"?>',namespace:'xmlns:d="defiant-namespace"',tabsize:4,is_safari:"undefined"!=typeof navigator?null!==navigator.userAgent.match(/safari/i):!1,render:function(t,e){var n,r,a=new XSLTProcessor,i=document.createElement("span"),o={match:"/"};switch(typeof t){case"object":this.extend(o,t),o.data||(o.data=e);break;case"string":o.template=t,o.data=e;break;default:throw"error"}if(o.data=JSON.toXML(o.data),this.xsl_template||this.gather_templates(),r=this.node.selectSingleNode(this.xsl_template,'//xsl:template[@name="'+o.template+'"]'),r.setAttribute("match",o.match),a.importStylesheet(this.xsl_template),i.appendChild(a.transformToFragment(o.data,document)),r.removeAttribute("match"),this.is_safari){n=i.getElementsByTagName("script");for(var s=0,u=n.length;u>s;s++)n[s].defer=!0}return i.innerHTML},gather_templates:function(){for(var t=document.getElementsByTagName("script"),e="",n=0,r=t.length;r>n;n++)"defiant/xsl-template"===t[n].type&&(e+=t[n].innerHTML);this.xsl_template=this.xmlFromString('<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" '+this.namespace+">"+e.replace(/defiant:(\w+)/g,"$1")+"</xsl:stylesheet>")},xmlFromString:function(t){var e,n=new DOMParser;return t=t.replace(/>\s{1,}</g,"><"),null===t.trim().match(/<\?xml/)&&(t=this.xml_decl+t),e=n.parseFromString(t,"text/xml")},extend:function(t,e){for(var n in e)t[n]&&"object"==typeof e[n]?this.extend(t[n],e[n]):t[n]=e[n];return t},result:function(){var t=function(e){for(var n in t.prototype)t.prototype.hasOwnProperty(n)&&(e[n]=t.prototype[n]);return e};return t.prototype={sum:function(t){for(var e=0,n=this.length,r=0;n>e;e++)r+=+this[e][t];return r},avg:function(t){return this.sum(t)/this.length},sortAsc:function(t){return this.sort(function(e,n){return e[t]-n[t]})},sortDesc:function(t){return this.sort(function(e,n){return n[t]-e[t]})},min:function(t,e){for(var n=0,r=this.length,a=[];r>n;n++)a.push(this[n][t]);return Math[e||"min"].apply(null,a)},max:function(t){return this.min(t,"max")},add:function(t,e,n){for(var r=0,a=this.length,i="string"==typeof e;a>r;r++)switch(n){case"divide":this[r][t]/=i?this[r][e]:+e;break;case"multiply":this[r][t]*=i?this[r][e]:+e;break;case"subtract":this[r][t]-=i?this[r][e]:+e;break;default:this[r][t]+=i?this[r][e]:+e}return this},subtract:function(t,e){return this.add(t,e,"subtract")},divide:function(t,e){return this.add(t,e,"divide")},multiply:function(t,e){return this.add(t,e,"multiply")},each:function(t){for(var e=0,n=this.length;n>e;e++)t(this[e]);return this}},new t(arguments[0])},ajax:function(r,a){var i=e.ajax;for(var o in n.prototype)n.prototype.hasOwnProperty(o)&&(i[o]=n.prototype[o]);return i.queue=new t(i),r?i.load(r,a):i},node:{}},n=function(){};return n.prototype={callback:function(t){return this.data=t,this.queue._paused=!1,this.queue.flush(),this},wait:function(t){var e=this,n=function(){setTimeout(function(){e.queue._paused=!1,e.queue.flush()},t)};return n._paused=!0,this.queue.add(n),this},load:function(t,e){var n=function(){var e=document.getElementsByTagName("head").item(0),n=document.createElement("script"),r=t.indexOf("?")>-1?"&":"?";n.setAttribute("type","text/javascript"),n.setAttribute("charset","utf-8"),n.setAttribute("src",t+r+"callback=Defiant.ajax.callback"),e.appendChild(n)},r=function(){e(this.data)};return n._paused=!0,this.queue.add(n),e&&this.queue.add(r),this},each:function(t){var e=this;return this.queue.add(function(){if(!e.res.length)return t.call(e);for(var n=0,r=e.res.length;r>n;n++)t.call(e,e.res[n])}),this},search:function(t){var e=this,n=function(){e.res=JSON.search(e.data,t)};return this.queue.add(n),this}},t.prototype={add:function(t){this._methods.push(t),this._paused||this.flush()},flush:function(){if(!this._paused)for(;this._methods[0];){var t=this._methods.shift();if(t.call(this._owner),t._paused){this._paused=!0;break}}}},e}(this),void 0!==window.ActiveXObject){var DOMParser=function(){};DOMParser.prototype.parseFromString=function(t,e){var n;return"undefined"!=typeof ActiveXObject?(n=new ActiveXObject("MSXML.DomDocument"),n.async=!1,n.loadXML(t),n):"undefined"!=typeof XMLHttpRequest?(n=new XMLHttpRequest,e||(e="application/xml"),n.open("GET","data:"+e+";charset=utf-8,"+encodeURIComponent(t),!1),n.overrideMimeType&&n.overrideMimeType(e),n.send(null),n.responseXML):void 0};var XMLSerializer=function(){};XMLSerializer.prototype={serializeToString:function(t){return t.xml}};var XSLTProcessor=function(){};XSLTProcessor.prototype={importStylesheet:function(t){this.xsldoc=t},transformToFragment:function(t){var e=t.transformNode(this.xsldoc),n=document.createElement("span");return n.innerHTML=e,n}},Object.prototype.getName=function(){var t=/function (.{1,})\(/,e=t.exec(""+this);return e&&e.length>1?e[1]:""}}String.prototype.fill||(String.prototype.fill=function(t,e){var n=this;for(e=e||" ";t>n.length;n+=e);return n}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/gm,"")}),String.prototype.count_nl||(String.prototype.count_nl=function(){var t=this.match(/\n/g);return t?t.length:0}),String.prototype.notabs||(String.prototype.notabs=function(){return this.replace(/\t/g,"")}),"undefined"==typeof JSON&&(window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(t){if(t instanceof Object){var e="";if(t.constructor===Array){for(var n=0;t.length>n;e+=this.stringify(t[n])+",",n++);return"["+e.substr(0,e.length-1)+"]"}if(t.toString!==Object.prototype.toString)return'"'+(""+t).replace(/"/g,"\\$&")+'"';for(var r in t)e+='"'+r.replace(/"/g,"\\$&")+'":'+this.stringify(t[r])+",";return"{"+e.substr(0,e.length-1)+"}"}return"string"==typeof t?'"'+t.replace(/"/g,"\\$&")+'"':t+""}}),JSON.toXML||(JSON.toXML=function(t){"use strict";var e={replace:function(t){for(var e in this)delete this[e];Defiant.extend(this,t)},to_xml:function(t){var e=this.hash_to_xml(null,t);return Defiant.xmlFromString(e)},hash_to_xml:function(t,e,n){var r,a,i,o,s,u,l,c=e.constructor===Array,h=[],d=[];for(r in e)if(a=e[r],(null===a||void 0===a||"NaN"==""+a)&&(a=null),o="@"===r.slice(0,1),s=n?t:r,s==+s&&e.constructor!==Object&&(s="d:item"),null===a?(u=null,l=!1):(u=a.constructor,l=void 0!==u.name?u.name:u.getName()),o)d.push(s.slice(1)+'="'+this.escape_xml(a)+'"'),"String"!==l&&d.push("d:"+s.slice(1)+'="'+l+'"');else if(null===a)h.push(this.scalar_to_xml(s,a));else switch(u){case Object:h.push(this.hash_to_xml(s,a));break;case Array:if(r===s){if(i=a.constructor===Array)for(var f=0,p=a.length;p>f;f++)a[f].constructor===Array&&(i=!0),i||a[f].constructor!==Object||(i=!0);h.push(this.scalar_to_xml(s,a,i));break}case String:"string"==typeof a&&(a=(""+a).replace(/\&/g,"&amp;"));case Number:case Boolean:"#text"===s&&"String"!==l&&d.push('d:constr="'+l+'"'),h.push(this.scalar_to_xml(s,a));break;case Function:break;default:}return t||(t="d:data",d.push(Defiant.namespace),c&&d.push('d:constr="Array"')),null===t.match(/^(?!xml)[a-z_][\w\d.:]*$/i)&&(d.push('d:name="'+t+'"'),t="d:name"),n?h.join(""):"<"+t+(d.length?" "+d.join(" "):"")+(h.length?">"+h.join("")+"</"+t+">":"/>")},scalar_to_xml:function(t,e,n){var r,a,i,o="";return null===t.match(/^(?!xml)[a-z_][\w\d.:]*$/i)&&(o+=' d:name="'+t+'"',t="d:name",n=!1),(null===e||"NaN"==""+e)&&(e=null),null===e?"<"+t+' d:constr="null"/>':1===e.length&&e[0].constructor===Object?(r=this.hash_to_xml(!1,e[0]),o=r.match(/<(.+?)( d:contr=".*?")>/),o=null!==o?o[2]:"",r=r.match(/(<.+?>)(.*?)(<\/d:data>)/i),"<"+t+o+' d:type="ArrayItem">'+r[2]+"</"+t+">"):n?this.hash_to_xml(t,e,!0):(a=e.constructor,i=a.name||a.getName(),r=a===Array?this.hash_to_xml("d:item",e,!0):this.escape_xml(e),"String"!==i&&(o+=' d:constr="'+i+'"'),"#text"===t?this.escape_xml(e):"<"+t+o+">"+r+"</"+t+">")},escape_xml:function(t){return(t+"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}},n=e.to_xml.call(e,t);return e.replace.call(t,Defiant.node.toJSON(n.documentElement)),n}),JSON.search||(JSON.search=function(t,e,n){"use strict";var r,a,i,o,s,u,l=JSON.toXML(t),c=l.documentElement,h=Defiant.node[n?"selectSingleNode":"selectNodes"](l,e),d=[],f=[],p=function(t){if(i===d[m].length)return t;switch(t.constructor){case Array:for(var e,n=0,r=t.length;r>n;n++)if(o.val===JSON.stringify(t[n],null,"	")&&d[m].length>i)return i++,o=d[m][i],p(t[n]);if(n===r){if(o.val===JSON.stringify(t,null,"	"))for(i++,o=d[m][i],n=0;r>n;n++)if(e=p(t[n]))return e;return t}break;default:if(s=d[m][i].node.nodeType,u=1===s?d[m][i].node.getAttribute("d:name"):!1,u=u||o.key,t=t[u],"object"!=typeof t)return i++,o=d[m][i],t;t.constructor===Object&&(i++,o=d[m][i])}return p(t)};for(n&&(h=[h]),m=0,g=h.length;g>m;m++)if(r=[],a=h[m],a!==c){for(;a!==c;)s=2===a.nodeType,r.push({node:a,key:(s?"@":"")+a.nodeName,val:s?a.value:Defiant.node.toJSON(a,"	")}),a=s?a.ownerElement:a.parentNode;d.push(r.reverse())}for(var m=0,g=d.length;g>m;m++)i=0,o=d[m][i],f.push(p(t));return this.trace=JSON.search.trace?JSON.mtrace(t,d):!1,Defiant.result(f)}),JSON.mtrace||(JSON.mtrace=function(t,e){"use strict";for(var n,r,a,i,o,s,u,l=[],c=JSON.stringify(t,null,"	").notabs(),h=0,d=e.length;d>h;h++){r=e[h],o=0,n=c,a=r.length,i=null===r[a-1].val.match(/[\{\}:\[\]]/g),i&&a--,r[0].val.notabs()!==c&&a>0&&(n=r[0].val.notabs(),o+=c.indexOf(n));for(var f=0,p=a;p>f;f++)o+=n.indexOf(r[f].val.notabs()),n=r[f].val.notabs();i&&(o+=n.indexOf('"'+r[f].key+'": ')),s=c.slice(0,o).count_nl()+1,u=r[i?a:a-1].val.count_nl(),l.push([s,u])}return l}),Defiant.node.selectNodes=function(t,e){if(t.evaluate){for(var n=t.createNSResolver(t.documentElement),r=t.evaluate(e,t,n,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),a=[],i=0,o=r.snapshotLength;o>i;i++)a.push(r.snapshotItem(i));return a}return t.selectNodes(e)},Defiant.node.selectSingleNode=function(t,e){if(t.evaluate){var n=this.selectNodes(t,e);return n.length>0?n[0]:null}return t.selectSingleNode(e)},Defiant.node.prettyPrint=function(t){var e=Defiant.tabsize,n=Defiant.xml_decl.toLowerCase(),r=new XMLSerializer,a=r.serializeToString(t);"development"!==Defiant.env&&(a=a.replace(/ \w+\:d=".*?"| d\:\w+=".*?"/g,""));for(var i,o,s=a.trim().replace(/(>)\s*(<)(\/*)/g,"$1\n$2$3"),u=s.split("\n"),l=-1,c=0,h=u.length;h>c;c++)(0!==c||u[c].toLowerCase()!==n)&&(i=null!==u[c].match(/<[A-Za-z_\:]+.*?>/g),o=null!==u[c].match(/<\/[\w\:]+>/g),null!==u[c].match(/<.*?\/>/g)&&(i=o=!0),i&&l++,u[c]="".fill(l,"	")+u[c],i&&o&&l--,!i&&o&&l--);return u.join("\n").replace(/\t/g,"".fill(e," "))},Defiant.node.toJSON=function(t,e){"use strict";var n=function(e){var r,a,i,o,s,u,l,c={};switch(e.nodeType){case 1:a=e.getAttribute("d:constr"),"Array"===a&&(c=[]),r=e.attributes;for(var h,d=0,f=r.length;f>d;d++)h=r.item(d),null===h.nodeName.match(/\:d|d\:/g)&&(a=e.getAttribute("d:"+h.nodeName),u=a&&"undefined"!==a?window[a]("false"===h.nodeValue?"":h.nodeValue):h.nodeValue,c["@"+h.nodeName]=u);break;case 3:a=e.parentNode.getAttribute("d:type"),u=a?window[a]("false"===e.nodeValue?"":e.nodeValue):e.nodeValue,c=u}if(e.hasChildNodes())for(var p=0,m=e.childNodes.length;m>p;p++)if(i=e.childNodes.item(p),o=i.nodeName,r=e.attributes,"d:name"===o&&(o=i.getAttribute("d:name")),"#text"===o)s=e.getAttribute("d:constr"),"undefined"===s&&(s=void 0),l=i.textContent||i.text,u="Boolean"===s&&"false"===l?"":l,s||r.length?s&&1===r.length?c=window[s](u):e.hasChildNodes()?3>r.length?c=s?window[s](u):u:c[o]=s?window[s](u):u:c[o]=s?window[s](u):u:c=u;else{if(c[o]){c[o].push?c[o].push(n(i)):c[o]=[c[o],n(i)];continue}switch(s=i.getAttribute("d:constr")){case"null":c.push?c.push(null):c[o]=null;break;case"Array":i.parentNode.firstChild===i&&"Array"===s&&"d:item"!==o?c[o]="d:item"===o||"Array"===s?[n(i)]:n(i):c.push?c.push(n(i)):c[o]=n(i);break;case"String":case"Number":case"Boolean":l=i.textContent||i.text,u="Boolean"===s&&"false"===l?"":l,c.push?c.push(window[s](u)):c[o]=n(i);break;default:c.push?c.push(n(i)):c[o]=n(i)}}return t.getAttribute&&"ArrayItem"===e.getAttribute("d:type")&&(c=[c]),c},r=9===t.nodeType?t.documentElement:t,a=n(r),i=a[r.nodeName];return r===r.ownerDocument.documentElement&&i&&i.constructor===Array&&(a=i),e&&"true"==""+e&&(e="	"),e?JSON.stringify(a,null,e):a},"undefined"!=typeof jQuery&&function(t){"use strict";t.fn.defiant=function(t,e){return this.html(Defiant.render(t,e)),this}}(jQuery);